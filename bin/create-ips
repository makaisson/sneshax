#!/usr/bin/env ruby

# Quick and dirty IPS generator.
# Based on http://www.smwiki.net/wiki/IPS_file_format

require 'shellwords'

original = ARGV.shift
modified = ARGV.shift

cmd = "cmp -l #{Shellwords.escape(original)} #{Shellwords.escape(modified)}"
diff = `#{cmd}`

if $?.success?
  $stderr.puts "files are idential: #{cmd}"
  exit 1
end

output = "PATCH"

# You could hella optimize this by lumping sequential bytes together and not
# writing out a single row for every one.
diff.each_line do |line|
  offset, _, new_value = *line.split(" ")
  # cmp outputs offset in decimal and values in octal. Ok...
  offset    = offset.to_i - 1
  new_value = new_value.to_i(8)

  output << \
    [offset].pack("N")[1..-1] + # faux 3-byte unsigned int packing, by doing a
                                # 4-byte and lopping off the start
    [1].pack("n") +             # 2-byte unsigned int
    [new_value].pack("C")       # 1-byte char
end

output << "EOF"

print output
